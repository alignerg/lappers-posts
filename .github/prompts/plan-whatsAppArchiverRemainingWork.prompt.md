# Plan: Complete WhatsApp Archiver Implementation

Approximately 45% of the WhatsApp Archiver project remains unimplemented. The Domain and Application layers are complete with full test coverage, but the Infrastructure layer, Console application, configuration, and documentation require implementation. All messages must be parsed into memory before Google Docs upload, with parsing errors causing application termination. The state file location is configurable via CLI but defaults to being alongside the chat file.

## Steps

1. **Add missing NuGet packages and sample data** - Install to Console project: `Microsoft.Extensions.Hosting`, `Microsoft.Extensions.Configuration.Json`, `Serilog.Sinks.File`, `Serilog.Extensions.Hosting`; install to Infrastructure Tests project: `Moq`, `FluentAssertions`; create sample WhatsApp export files in [`tests/SampleData/`](tests/SampleData/): `sample-dd-mm-yyyy.txt` (DD/MM/YYYY HH:mm format), `sample-m-d-yy.txt` (M/D/YY, H:mm AM/PM format), `sample-edge-cases.txt` (multi-line messages, emoji, special characters, multiple senders, system messages).

2. **Implement WhatsAppTextFileParser with tests** - Create [`WhatsAppTextFileParserTests.cs`](tests/WhatsAppArchiver.Infrastructure.Tests/) with tests: `ParseChatFileAsync_ValidFileWithDDMMYYYYFormat_ReturnsCompleteExport`, `ParseChatFileAsync_ValidFileWithMDYYFormat_ReturnsCompleteExport`, `ParseChatFileAsync_MultiLineMessages_ParsesCorrectly`, `ParseChatFileAsync_UnparseableLines_TracksInMetadata`, `ParseChatFileAsync_EmptyFile_ReturnsEmptyExport`, `ParseChatFileAsync_MessagesWithEmoji_HandlesCorrectly`, `ParseChatFileAsync_ValidatesMessageOrdering_MaintainsChronologicalOrder`; implement [`WhatsAppTextFileParser.cs`](src/WhatsAppArchiver.Infrastructure/) with `IChatParser` interface, regex patterns for both date formats, multi-line continuation logic, error collection with line numbers, `ChatExport` aggregate return, Polly retry policy (2s, 4s, 8s backoff).

3. **Implement GoogleDocsServiceAccountAdapter with tests** - Create [`GoogleDocsServiceAccountAdapterTests.cs`](tests/WhatsAppArchiver.Infrastructure.Tests/) with tests using Moq: `Constructor_ValidCredentials_InitializesSuccessfully`, `UploadContentAsync_ValidContent_CallsApiSuccessfully`, `UploadContentAsync_ApiError_RetriesWithExponentialBackoff`, `AppendContentAsync_ValidContent_AppendsToDocument`, `UploadContentAsync_CancellationRequested_ThrowsOperationCanceledException`, `UploadContentAsync_BatchParagraphs_InsertsAllContent`; implement [`GoogleDocsServiceAccountAdapter.cs`](src/WhatsAppArchiver.Infrastructure/) with `IGoogleDocsService` interface, Google.Apis.Docs.v1 client initialization, service account authentication from JSON key file, batch paragraph insertion methods, Polly retry policy for API failures.

4. **Implement JsonFileStateRepository with tests** - Create [`JsonFileStateRepositoryTests.cs`](tests/WhatsAppArchiver.Infrastructure.Tests/) with tests: `SaveCheckpointAsync_NewCheckpoint_CreatesJsonFile`, `GetCheckpointAsync_ExistingFile_LoadsCheckpoint`, `GetCheckpointAsync_NoFile_CreatesNewCheckpoint`, `SaveCheckpointAsync_AtomicWrite_UsesTemporaryFile`, `SaveCheckpointAsync_ConcurrentAccess_HandlesFileLocking`, `GetCheckpointAsync_CorruptedJson_ThrowsException`, `SaveCheckpointAsync_ValidCheckpoint_SerializesCorrectly`; implement [`JsonFileStateRepository.cs`](src/WhatsAppArchiver.Infrastructure/) with `IProcessingStateService` interface, atomic file writes using temp file + rename pattern, file locking with `FileStream` exclusive access, System.Text.Json serialization for `ProcessingCheckpoint`, Polly retry policy for file I/O.

5. **Create infrastructure integration tests** - Create [`EndToEndIntegrationTests.cs`](tests/WhatsAppArchiver.Infrastructure.Tests/) with tests crossing layer boundaries: `ParseAndFormat_SampleChat_ProducesExpectedOutput` using real file I/O with sample data, `FilterBySender_MultiSenderChat_ReturnsOnlySenderMessages` validating specification pattern, `ProcessingCheckpoint_SaveAndLoad_MaintainsState` verifying state persistence, configure test fixtures with temporary directories and cleanup, ensure tests validate complete workflows from file parsing through formatting to state persistence.

6. **Configure Console application hosting and DI** - Set up `Host.CreateDefaultBuilder` in [`Program.cs`](src/WhatsAppArchiver.Console/Program.cs), configure DI container with service registrations for `IChatParser` → `WhatsAppTextFileParser`, `IGoogleDocsService` → `GoogleDocsServiceAccountAdapter`, `IProcessingStateService` → `JsonFileStateRepository`, register all `IMessageFormatter` implementations and `FormatterFactory`, configure service lifetimes (Singleton for stateless services, Scoped for handlers), add configuration binding for `appsettings.json`.

7. **Implement CLI with System.CommandLine** - Define command in [`Program.cs`](src/WhatsAppArchiver.Console/Program.cs) with options: `--chat-file` (required, file path validation), `--sender-filter` (required, non-empty string validation), `--doc-id` (required, Google Docs document ID format), `--format` (optional, enum: default|compact|verbose, default: default), `--state-file` (optional, file path, default: `{chat-file-directory}/processingState.json`), `--config` (optional, appsettings.json path), bind options to handler method with dependency injection from host services.

8. **Configure Serilog and implement orchestration** - Set up Serilog in [`Program.cs`](src/WhatsAppArchiver.Console/Program.cs) with `UseSerilog`, configure console sink with colored output and rolling file sink with daily rotation, add enrichers for correlation IDs, configure log levels from appsettings.json; implement orchestration handler to parse entire chat file into memory using `IChatParser.ParseChatFileAsync`, validate parsing results and terminate with exit code 1 if errors found with detailed error report, log successful parse, upload formatted messages to Google Docs, update `ProcessingCheckpoint` only after successful upload, handle graceful shutdown with cancellation tokens, return appropriate exit codes.

9. **Create configuration files** - Create [`appsettings.json`](src/WhatsAppArchiver.Console/) with schema: `GoogleServiceAccount.CredentialsPath` (supports absolute and relative paths), `DefaultFormatter` (default|compact|verbose), `Logging` section (MinimumLevel, FilePath, RetentionDays), `RetryPolicies` (MaxAttempts: 3, BackoffDelaySeconds: [2, 4, 8]) with explanatory comments; create [`appsettings.sample.json`](src/WhatsAppArchiver.Console/) template with placeholders; create [`processingState.sample.json`](tests/SampleData/) showing state file structure with example data and schema documentation.

10. **Create comprehensive documentation** - Create root [`README.md`](/Users/garethd/code/lappers-posts/README.md) with project overview and purpose, prerequisites (.NET 10 SDK, Google Cloud project, service account setup), architecture overview explaining DDD layers, WhatsApp export format requirements with examples for both date formats, step-by-step Google service account creation guide (create project, enable Google Docs API, create service account, download JSON key, share document with service account email), installation instructions (`dotnet restore`, `dotnet build`), detailed CLI usage examples for all arguments, state file behavior explanation, troubleshooting guide for parsing errors and API authentication issues, building/running instructions, testing instructions with coverage commands (`dotnet test --collect:"XPlat Code Coverage"`), create [`.coverletrc.json`](/Users/garethd/code/lappers-posts/) with coverage configuration targeting 85% for Domain and Application layers.

## Further Considerations

1. **Parsing Error Detail Level** - Should parsing errors include: A) Line number and raw content only, B) Line number, raw content, and regex pattern attempted, C) All details plus suggestions for manual correction? This affects user experience when chat exports have format inconsistencies.

2. **State File Behavior on Parse Failure** - When parsing fails and application terminates, should the state file: A) Not be updated at all, B) Be updated with parse attempt timestamp but no message IDs, C) Include partial success metadata (number of successfully parsed messages before failure)?

3. **Google Service Account Credentials** - For `appsettings.json`, should the Google service account credentials path: A) Be absolute path only, B) Support both absolute and relative paths from executable location, C) Support environment variables for credentials content directly (e.g., for containerized deployments)?
